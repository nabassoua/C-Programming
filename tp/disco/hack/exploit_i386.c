#include <stdio.h>

typedef unsigned int uInt_32; 

#define PRINT_DEBUG 0
#define OFFSET_RET 1
#define OFFSET_SHELLCODE 0x1000
#define BUFFER_NOP 7
#define NOP 0x90

inline uInt_32 getsp(void) __attribute__((always_inline));
inline uInt_32 getbp(void) __attribute__((always_inline));

int main(int argc, char** argv) 
{
	uInt_32 *sp = (uInt_32 *) getsp();
	uInt_32 *bp = (uInt_32 *) getbp();
	char *new_ptr_shellcode = (char *) sp - OFFSET_SHELLCODE;	
	char shellcode[] = {
		"\x6a\x00\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\xba\x00"
		"\x00\x00\x00\x89\xd1\x89\xe3\xb8\x0b\x00\x00\x00\xcd\x80"
		};	

	/* replace return address by new address of shellcode */
	//TODO

	/* copy shellcode and nop instructions far away on stack */
	//TODO

	#if PRINT_DEBUG
	printf("SP : 0x%x\n", (uInt_32) sp);
	printf("BP : 0x%x\n", (uInt_32) bp);
	printf("[SP BP] : %u\n", (uInt_32) sp - (uInt_32) bp);	
	printf("ptr return to startup : 0x%x\n",  (uInt_32) (bp+OFFSET_RET));
	printf("ptr shellcode : 0x%x\n", (uInt_32) shellcode);
	printf("new ptr shellcode : 0x%x\n",  (uInt_32) *(bp+OFFSET_RET));
	#endif

  return 0;
}

inline uInt_32 getsp(void) {
  __asm__("mov    %esp,%eax");
}

inline uInt_32 getbp(void) {
  __asm__("mov    %ebp,%eax");
}
